import { describe, expect, it } from 'vitest'
import { ComposerQuickActions } from '.'
import { initializeChainData, initializeLenderData } from '@1delta/data-sdk'

const baseUrl = 'https://raw.githubusercontent.com/1delta-DAO/lender-metadata/multi-fetch'
const aavePools = baseUrl + '/config/aave-pools.json'

const aaveReserves = baseUrl + '/data/aave-reserves.json'
const aaveTokens = baseUrl + '/data/aave-tokens.json'
const baseUrlChains = 'https://raw.githubusercontent.com/1delta-DAO/chains/main'

const chains = baseUrlChains + '/data.json'

async function fetchLenderMetaFromDirAndInitialize() {
  const { aavePoolsOverride, aaveReservesOverride, aaveTokensOverride, chainsOverride } = await fetchLenderMetaFromDir()

  initializeLenderData({
    aaveTokensOverride,
    aavePoolsOverride,
    aaveReservesOverride,
  })

  initializeChainData({ chainsOverride })
}

async function fetchLenderMetaFromDir() {
  const promises = [aavePools, aaveReserves, aaveTokens, chains].map(async (a) =>
    fetch(a).then(async (b) => await b.json())
  )

  const [aavePoolsOverride, aaveReservesOverride, aaveTokensOverride, chainsOverride] = await Promise.all(promises)

  return {
    aavePoolsOverride,
    aaveReservesOverride,
    aaveTokensOverride,
    chainsOverride,
  }
}

describe('Sim Tests - Metis', () => {
  it(
    'Swap and Repay',
    async () => {
      await fetchLenderMetaFromDirAndInitialize()
      const { calldata, value } = ComposerQuickActions.composedQuickAction(
        // @ts-ignore
        PARAMS
      )
      expect(calldata).to.equal(
        '0x20fca1154c643c32638aee9a43eee7f377f515c80100000000000000000002e891c330dfea06ab206131b5fae19ea4f9d964eac0408e4408b66337b500000000000000000002e891c330dfea0684e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000e801010000003d02000000478946bcd4a5a22b316470f5486fafb928c0ba2500000000000000000002e891c330dfea0100000000000000000000000000000000000000000aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0b2c639c533813f4aa9d7837caf62653d097ff85cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000685e7d6000000054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000001e99d54f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff850000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea720000000000000000000000000000000000000000000000000002e891c330dfea00000000000000000000000000000000000000000000000000000000001e8254000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002807b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22322e3030353935353438383234313837222c22416d6f756e744f7574555344223a22322e30303538383436393932383737343733222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2232303035343631222c2254696d657374616d70223a313735313032313734342c22526f7574654944223a2263656233653662362d323063322d346663652d393363302d3362383166306136663033653a35663562316637662d373865642d346462342d383937612d333339376432626133373434222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22415256735877583064542b4b2b75376e6a38772b68672f336c62437836334b2b454f764e4c6e44397347576c594c7a446f556f4d387a347a326d41774b4a7365784c322f38627448465444636e72784c4549664a73356e54506b3252456576566756464d39466a4a396333594d55394b61356a44673077596d6e4f7747347a7948334843765a44735a4830387254304174753179636b4a44677a525379775876696e785a4877766379574a4336754a6d5a497762594b38726d682b4a346c50766d75323357377742437478702f64446b4b6c6c6a43784935465735686f5a796c4658426a7473493542454f456e4642616638526954717653466231386b535542785a484178462b6365744e69314f4b33666a306f6b4e4b5766457664534e5369544841575278744662526158394d55673268636c66647a636b68574b696d3169575237436d6741585357323752554b555942304456773d3d227d7d40010000000000000000000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000000000000040050b2c639c533813f4aa9d7837caf62653d097ff85794a61358d6845594f94dc1db02a252b5b4814ad300203e70b2c639c533813f4aa9d7837caf62653d097ff850000000000000000000000000000000091ae002a960e63ccb0e5bde83a8c13e51e1cb91a025d557b07776d12967914379c71a1310e917c7555794a61358d6845594f94dc1db02a252b5b4814ad40010b2c639c533813f4aa9d7837caf62653d097ff8591ae002a960e63ccb0e5bde83a8c13e51e1cb91a0000000000000000000000000000000000'
      )
    },
    { timeout: 25000 }
  )
})

// network OP
// address mockSender = 0x91ae002a960e63Ccb0E5bDE83A8C13E51e1cB91A;
// uint256 internal constant forkBlock = 2088789;
const PARAMS = {
  quickActionType: 'Repay',
  trade: {
    tradeType: 0,
    inputAmount: {
      currency: {
        chainId: '10',
        name: 'Ether',
        symbol: 'ETH',
        decimals: 18,
        address: '0x0000000000000000000000000000000000000000',
      },
      amount: '818662696083434',
    },
    outputAmount: {
      currency: {
        chainId: '10',
        name: 'USD Coin',
        symbol: 'USDC',
        address: '0x0b2c639c533813f4aa9d7837caf62653d097ff85',
        decimals: 6,
      },
      amount: '2005461',
    },
    aggregator: 'Kyberswap',
    target: '0x6131B5fae19EA4f9D964eAc0408E4408b66337b5',
    approvalTarget: '0x6131B5fae19EA4f9D964eAc0408E4408b66337b5',
    stringified: '818662696083434-ETH->2005461-USDC-Kyberswap',
    inputAmountRealized: 0.000818662696083434,
    outputAmountRealized: 2.005461,
    slippage: {
      numerator: '30',
      denominator: '10000',
      isPercent: true,
    },
  },
  lender: 'AAVE_V3',
  aaveInterestMode: 2,
  slippageBps: '3000',
  externalCall: {
    calldata:
      '0xe21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000e801010000003d02000000478946bcd4a5a22b316470f5486fafb928c0ba2500000000000000000002e891c330dfea0100000000000000000000000000000000000000000aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0b2c639c533813f4aa9d7837caf62653d097ff85cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000685e7d6000000054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000001e99d54f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff850000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea720000000000000000000000000000000000000000000000000002e891c330dfea00000000000000000000000000000000000000000000000000000000001e8254000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002807b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22322e3030353935353438383234313837222c22416d6f756e744f7574555344223a22322e30303538383436393932383737343733222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2232303035343631222c2254696d657374616d70223a313735313032313734342c22526f7574654944223a2263656233653662362d323063322d346663652d393363302d3362383166306136663033653a35663562316637662d373865642d346462342d383937612d333339376432626133373434222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22415256735877583064542b4b2b75376e6a38772b68672f336c62437836334b2b454f764e4c6e44397347576c594c7a446f556f4d387a347a326d41774b4a7365784c322f38627448465444636e72784c4549664a73356e54506b3252456576566756464d39466a4a396333594d55394b61356a44673077596d6e4f7747347a7948334843765a44735a4830387254304174753179636b4a44677a525379775876696e785a4877766379574a4336754a6d5a497762594b38726d682b4a346c50766d75323357377742437478702f64446b4b6c6c6a43784935465735686f5a796c4658426a7473493542454f456e4642616638526954717653466231386b535542785a484178462b6365744e69314f4b33666a306f6b4e4b5766457664534e5369544841575278744662526158394d55673268636c66647a636b68574b696d3169575237436d6741585357323752554b555942304456773d3d227d7d',
    target: '0x6131B5fae19EA4f9D964eAc0408E4408b66337b5',
    value: '818662696083434',
    callForwarder: '0xfCa1154C643C32638AEe9a43eeE7f377f515c801',
  },
  composer: '0xCDef0A216fcEF809258aA4f341dB1A5aB296ea72',
  maximum: false,
  receiver: '0x91ae002a960e63Ccb0E5bDE83A8C13E51e1cB91A',
}
