import { describe, it, expect } from 'vitest'
import { ComposerMargin } from './plain'
import { initializeChainData, initializeLenderData } from '@1delta/data-sdk'

const baseUrl = 'https://raw.githubusercontent.com/1delta-DAO/lender-metadata/main'
const aavePools = baseUrl + '/config/aave-pools.json'
const aaveOracles = baseUrl + '/data/aave-oracles.json'
const morphoOracles = baseUrl + '/data/morpho-oracles.json'
const compoundV2Pools = baseUrl + '/config/compound-v2-pools.json'
const compoundV3Pools = baseUrl + '/config/compound-v3-pools.json'
// const initPools = baseUrl + '/config/init-pools.json'
const morphoPools = baseUrl + '/config/morpho-pools.json'

const aaveReserves = baseUrl + '/data/aave-reserves.json'
const compoundV2Reserves = baseUrl + '/data/compound-v2-reserves.json'
const compoundV3Reserves = baseUrl + '/data/compound-v3-reserves.json'
const initConfig = baseUrl + '/data/init-config.json'
const aaveTokens = baseUrl + '/data/aave-tokens.json'
const compoundV2CTokens = baseUrl + '/data/compound-v2-c-tokens.json'
const compoundV3Base = baseUrl + '/data/compound-v3-base-data.json'
const baseUrlChains = 'https://raw.githubusercontent.com/1delta-DAO/chains/main'

const chains = baseUrlChains + '/data.json'

function inititalizeAllData(params: any) {
  const { chainsOverride, ...lenderOverrides } = params

  initializeLenderData(lenderOverrides)

  initializeChainData({ chainsOverride })
}

async function fetchLenderMetaFromDirAndInitialize() {
  const params = await fetchLenderMetaFromDir()
  inititalizeAllData(params)
}

async function fetchLenderMetaFromDir() {
  const promises = [
    aavePools,
    compoundV2Pools,
    compoundV3Pools,
    // initPools,
    morphoPools,
    aaveReserves,
    compoundV2Reserves,
    compoundV3Reserves,
    initConfig,
    aaveTokens,
    compoundV2CTokens,
    compoundV3Base,
    aaveOracles,
    morphoOracles,
    chains,
  ].map(async (a) => fetch(a).then(async (b) => await b.json()))

  const [
    aavePoolsOverride,
    compoundV2PoolsOverride,
    compoundV3PoolsOverride,
    // initPoolsOverride,
    morphoPoolsOverride,
    aaveReservesOverride,
    compoundV2ReservesOverride,
    compoundV3ReservesOverride,
    initConfigOverride,
    aaveTokensOverride,
    compoundV2TokensOverride,
    compoundV3BaseDataOverride,
    aaveOraclesOverride,
    morphoOraclesOverride,
    chainsOverride,
  ] = await Promise.all(promises)

  return {
    aavePoolsOverride,
    compoundV2PoolsOverride,
    compoundV3PoolsOverride,
    // initPoolsOverride,
    morphoPoolsOverride,
    aaveReservesOverride,
    compoundV2ReservesOverride,
    compoundV3ReservesOverride,
    initConfigOverride,
    aaveTokensOverride,
    compoundV2TokensOverride,
    compoundV3BaseDataOverride,
    aaveOraclesOverride,
    morphoOraclesOverride,
    chainsOverride,
  }
}

describe('composeDirectMoneyMarketAction', async () => {
  /** Important: set lender data here */
  await fetchLenderMetaFromDirAndInitialize()

  describe('Moonwell margin', async () => {
    it('should create calldata for collateral swap with extra weth unwrap', async () => {
      const result = ComposerMargin.createMarginFlashLoan(MOONWELL_CSWAP as any)

      //   expect(result.value).toBeUndefined() // No ETH value for ERC20 deposit
      expect(result).toEqual(
        '0x40054200000000000000000000000000000000000006ce95afbb8ea029495c66020883f87aae8864af9260004200000000000000000000000000000000000006ce95afbb8ea029495c66020883f87aae8864af92000000000000000000005aeeae12fe110cd80040014200000000000000000000000000000000000006fca1150ea45ba50323c27a7d5e823d92d2e59a0501000000000000000000005aeeae12fe1120fca1150ea45ba50323c27a7d5e823d92d2e59a05000000000000000000000000000000000b35400542000000000000000000000000000000000000066131b5fae19ea4f9d964eac0408e4408b66337b5206131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000ae4e21fd0e9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000500000000000000000000005aeeae12fe11000000000000000000005aeeae12fe11000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041dbd79f825867cc137453e54e8426a63db0f4041055079060d21cd1e632fd573140c9274b0ec04ef153a003b0dd513d89f3b0d3f78b956151ff1d9dc71bc2ccbe1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea7200000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000180000000000000000000005662bef8715c000000000000000000005f7a9d2d8ac5000000000000000000005aeeae12fe110000000000000000000000000005acb100000000000000000000000000000000000000000000010000000f42400000000000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029e8d6080000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000000161f598cd000000000000000092934e8915576ff4684cad10ee82dfe788e9250c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000420000000000000000000000000000000000000680000000000000000000000005f59771000000000000000000005aeeae12fe1100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000005aeeae12fe113b9d6e0900000000000000015455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb000000000000000000000000000000000000000000000000000000000000000400000000000000000000000001fb3cf6e48f1e7b10213e7b6d87d4c073c7fdb7b000000000000000000000000fff6fbe64b68d618d47c209fe40b0d8ee6e23c900000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff85800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000060000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea7200000000000000000000000000000000000000000000000000005aeeae12fe11000000000000000000000000000000000000000000000000000000000005a3f800000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000100000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000005aeeae12fe1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002837b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22302e3337313931303136303933373730373936222c22416d6f756e744f7574555344223a22302e3337313932333532343634373338303135222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22333731383838222c2254696d657374616d70223a313736323137373931352c22526f7574654944223a2234626632343062342d353864322d343264332d613166622d6361656466623337376632373a38356538623332362d396639322d343036352d393930642d623230613465633566303032222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224d466b614345416265472f6644496c54787470677a507654356c5343545a6f5350726d495a77466a726458694b4c65674546492b4b4339337934755138457143456364744f4f702b6e563657304e554c366f52476f39686d794f42692b4479415676554879363847533644674949385a75354c506d314e333049536c316f6b4e4d756d415162514d2b466944517a5a46722f624b38337848443535502b6774366a7437677843326a4b454a323870635153797a2f7847506d4d48657362454668506654635a52765a4575707734792b5234596b755343725573524a41506334435846754d51695847573537514d2b4d7a776559515268686b6b434767546a62365a6d704d4a7452766d6234304951445a2f4b6b57395569487446486b4f65787556466865634255415a4a3632564d584c366c42366570464b726e435231613936524a69784b2f4272676a617633326e4e5a62386233413d3d227d7d000000000000000000000000000000000000000000000000000000000040050b2c639c533813f4aa9d7837caf62653d097ff858e08617b0d66359d73aa11e11017834c2915552530000f9f0b2c639c533813f4aa9d7837caf62653d097ff8501000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e58e08617b0d66359d73aa11e11017834c2915552530030f9f42000000000000000000000000000000000000060000ffffffffffffffffffffffffffffcdef0a216fcef809258aa4f341db1a5ab296ea72b4104c02bbf4e9be85aaa41a62974e4e28d59a33400100000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000040014200000000000000000000000000000000000006cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000000000000040014200000000000000000000000000000000000006bada9c382165b31419f4cc0edf0fa84f80a3c8e50000000000000000000000000000000000'
      )
    })

     it('should create calldata for USDT-USDC close all out on', async () => {
      const result = ComposerMargin.createMarginFlashLoan(MOONWELL_CLOSE as any)

      //   expect(result.value).toBeUndefined() // No ETH value for ERC20 deposit
      expect(result).toEqual(
        '0x40050b2c639c533813f4aa9d7837caf62653d097ff85ce95afbb8ea029495c66020883f87aae8864af9260000b2c639c533813f4aa9d7837caf62653d097ff85ce95afbb8ea029495c66020883f87aae8864af92000000000000000000000000000187e202380040010b2c639c533813f4aa9d7837caf62653d097ff85fca1150ea45ba50323c27a7d5e823d92d2e59a0501000000000000000000000000000187e220fca1150ea45ba50323c27a7d5e823d92d2e59a0500000000000000000000000000000000010b40050b2c639c533813f4aa9d7837caf62653d097ff85ca423977156bb05b13a2ba3b76bc5419e2fe968020ca423977156bb05b13a2ba3b76bc5419e2fe96800000000000000000000000000000000000ba83bd37f900010b2c639c533813f4aa9d7837caf62653d097ff850007030187e2030187dd00c49b0001B8fc6Bf89E16e66b5FA9aA44b8393a588Cf1e77c00000001CDef0A216fcEF809258aA4f341dB1A5aB296ea720000000003010203000d010101020100000a00000100ff00000000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff8594b008aa00579c1307b0ef2c499ad98a8ce58e58000000000000000000000000000000000000000000000000400594b008aa00579c1307b0ef2c499ad98a8ce58e58a3a53899ee8f9f6e963437c5b3f805fec538bf8430020f9f94b008aa00579c1307b0ef2c499ad98a8ce58e580000ffffffffffffffffffffffffffffbada9c382165b31419f4cc0edf0fa84f80a3c8e5a3a53899ee8f9f6e963437c5b3f805fec538bf8430030f9f0b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000000187e2cdef0a216fcef809258aa4f341db1a5ab296ea728e08617b0d66359d73aa11e11017834c29155525400194b008aa00579c1307b0ef2c499ad98a8ce58e58bada9c382165b31419f4cc0edf0fa84f80a3c8e50000000000000000000000000000000000400194b008aa00579c1307b0ef2c499ad98a8ce58e58bada9c382165b31419f4cc0edf0fa84f80a3c8e50000000000000000000000000000000000'
      )
    })
  })
})

const MOONWELL_CSWAP = {
  trade: {
    tradeType: 0,
    inputAmount: {
      currency: {
        chainId: '10',
        decimals: 18,
        name: 'Wrapped Ether',
        address: '0x4200000000000000000000000000000000000006',
        symbol: 'WETH',
        assetGroup: 'ETH',
        currencyId: 'Wrapped Ether::WETH',
        props: {
          wnative: true,
        },
      },
      amount: '99981169196561',
    },
    outputAmount: {
      currency: {
        chainId: '10',
        decimals: 6,
        name: 'USD Coin',
        address: '0x0b2c639c533813f4aa9d7837caf62653d097ff85',
        symbol: 'USDC',
        assetGroup: 'USDC',
        currencyId: 'USD Coin::USDC',
      },
      amount: '371889',
    },
    aggregator: 'Kyberswap',
    target: '0x6131B5fae19EA4f9D964eAc0408E4408b66337b5',
    approvalTarget: '0x6131B5fae19EA4f9D964eAc0408E4408b66337b5',
    stringified: '99981169196561-WETH->371889-USDC-Kyberswap',
    flashLoanSource: 'MORPHO_BLUE',
    inputAmountRealized: 0.000100001169430448,
    outputAmountRealized: 0.371889,
    slippage: 0.6,
  },
  externalCall: {
    callForwarder: '0xfCa1150eA45ba50323C27a7d5E823d92D2e59A05',
    calldata:
      '0xe21fd0e9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000500000000000000000000005aeeae12fe11000000000000000000005aeeae12fe11000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041dbd79f825867cc137453e54e8426a63db0f4041055079060d21cd1e632fd573140c9274b0ec04ef153a003b0dd513d89f3b0d3f78b956151ff1d9dc71bc2ccbe1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea7200000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000180000000000000000000005662bef8715c000000000000000000005f7a9d2d8ac5000000000000000000005aeeae12fe110000000000000000000000000005acb100000000000000000000000000000000000000000000010000000f42400000000000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029e8d6080000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000000161f598cd000000000000000092934e8915576ff4684cad10ee82dfe788e9250c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000420000000000000000000000000000000000000680000000000000000000000005f59771000000000000000000005aeeae12fe1100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000005aeeae12fe113b9d6e0900000000000000015455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb000000000000000000000000000000000000000000000000000000000000000400000000000000000000000001fb3cf6e48f1e7b10213e7b6d87d4c073c7fdb7b000000000000000000000000fff6fbe64b68d618d47c209fe40b0d8ee6e23c900000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff85800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000060000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea7200000000000000000000000000000000000000000000000000005aeeae12fe11000000000000000000000000000000000000000000000000000000000005a3f800000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000100000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000005aeeae12fe1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002837b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22302e3337313931303136303933373730373936222c22416d6f756e744f7574555344223a22302e3337313932333532343634373338303135222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22333731383838222c2254696d657374616d70223a313736323137373931352c22526f7574654944223a2234626632343062342d353864322d343264332d613166622d6361656466623337376632373a38356538623332362d396639322d343036352d393930642d623230613465633566303032222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224d466b614345416265472f6644496c54787470677a507654356c5343545a6f5350726d495a77466a726458694b4c65674546492b4b4339337934755138457143456364744f4f702b6e563657304e554c366f52476f39686d794f42692b4479415676554879363847533644674949385a75354c506d314e333049536c316f6b4e4d756d415162514d2b466944517a5a46722f624b38337848443535502b6774366a7437677843326a4b454a323870635153797a2f7847506d4d48657362454668506654635a52765a4575707734792b5234596b755343725573524a41506334435846754d51695847573537514d2b4d7a776559515268686b6b434767546a62365a6d704d4a7452766d6234304951445a2f4b6b57395569487446486b4f65787556466865634255415a4a3632564d584c366c42366570464b726e435231613936524a69784b2f4272676a617633326e4e5a62386233413d3d227d7d0000000000000000000000000000000000000000000000000000000000',
    target: '0x6131B5fae19EA4f9D964eAc0408E4408b66337b5',
    value: '0',
  },
  account: '0xbadA9c382165b31419F4CC0eDf0Fa84f80A3C8E5',
  marginData: {
    irModeIn: 0,
    irModeOut: 0,
    marginTradeType: 'CollateralSwap',
    lender: 'MOONWELL',
  },
  isMaxIn: true,
  isMaxOut: false,
  composerOverride: '0xCDef0A216fcEF809258aA4f341dB1A5aB296ea72',
  flashInfoOverride: {
    data: {
      id: 0,
      fee: '0',
    },
    provider: 'MORPHO_BLUE',
    providerAddress: '0xce95AfbB8EA029495c66020883F87aaE8864AF92',
    poolType: 0,
  },
}

const MOONWELL_CLOSE = {
  trade: {
    tradeType: 0,
    inputAmount: {
      currency: {
        chainId: '10',
        decimals: 6,
        name: 'USD Coin',
        address: '0x0b2c639c533813f4aa9d7837caf62653d097ff85',
        symbol: 'USDC',
        logoURI: 'https://ethereum-optimism.github.io/data/USDC/logo.png',
        assetGroup: 'USDC',
        currencyId: 'USD Coin::USDC',
        tags: ['debridge', 'biconomy-gas-token', 'AAVE_V3', 'XLEND', 'COMPOUND_V3_USDC', 'COMPOUND_V3_WETH', 'VENUS'],
      },
      amount: '100322',
    },
    outputAmount: {
      currency: {
        chainId: '10',
        decimals: 6,
        name: 'Tether USD',
        address: '0x94b008aa00579c1307b0ef2c499ad98a8ce58e58',
        symbol: 'USDT',
        logoURI:
          'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xdAC17F958D2ee523a2206206994597C13D831ec7/logo.png',
        assetGroup: 'USDT',
        currencyId: 'Tether USD::USDT',
        tags: [
          'openocean',
          'debridge',
          'biconomy-gas-token',
          'AAVE_V3',
          'GRANARY',
          'XLEND',
          'COMPOUND_V3_WETH',
          'COMPOUND_V3_USDT',
          'VENUS',
        ],
      },
      amount: '100317',
    },
    aggregator: 'Odos',
    target: '0xca423977156bb05b13a2ba3b76bc5419e2fe9680',
    approvalTarget: '0xca423977156bb05b13a2ba3b76bc5419e2fe9680',
    stringified: '100322-USDC->100317-USDT-Odos',
    flashLoanSource: 'MORPHO_BLUE',
    inputAmountRealized: 0.100322,
    outputAmountRealized: 0.100317,
    slippage: 0.3,
  },
  externalCall: {
    callForwarder: '0xfCa1150eA45ba50323C27a7d5E823d92D2e59A05',
    calldata:
      '0x83bd37f900010b2c639c533813f4aa9d7837caf62653d097ff850007030187e2030187dd00c49b0001B8fc6Bf89E16e66b5FA9aA44b8393a588Cf1e77c00000001CDef0A216fcEF809258aA4f341dB1A5aB296ea720000000003010203000d010101020100000a00000100ff00000000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff8594b008aa00579c1307b0ef2c499ad98a8ce58e58000000000000000000000000000000000000000000000000',
    target: '0xca423977156bb05b13a2ba3b76bc5419e2fe9680',
    value: '0',
  },
  account: '0xbadA9c382165b31419F4CC0eDf0Fa84f80A3C8E5',
  marginData: {
    irModeIn: 0,
    irModeOut: 2,
    marginTradeType: 'Close',
    lender: 'MOONWELL',
  },
  isMaxIn: false,
  isMaxOut: true,
  composerOverride: '0xCDef0A216fcEF809258aA4f341dB1A5aB296ea72',
  flashInfoOverride: {
    data: {
      id: 0,
      fee: '0',
    },
    provider: 'MORPHO_BLUE',
    providerAddress: '0xce95AfbB8EA029495c66020883F87aaE8864AF92',
    poolType: 0,
  },
}
